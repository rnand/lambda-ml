/*! CMB Simulator - 2013-06-27
* Includes:
*    FFT Copyright Â© 2012 wellflat Licensed under the MIT License (https://github.com/wellflat/javascript-labs/tree/master/cv/fft)
*    Ned Wright's Cosmology Calculator (refactored from http://www.astro.ucla.edu/~wright/CosmoCalc.html)
*    Full Screen API (http://johndyer.name/native-fullscreen-javascript-api-plus-jquery-plugin/)
*    jQuery UI Touch Punch 0.2.2 (https://github.com/furf/jquery-ui-touch-punch)
*    Ziggurat (http://www.filosophy.org/post/35/normaldistributed_random_values_in_javascript_using_the_ziggurat_algorithm/)
*/
(function($){function ParameterSlider(inp){this.select=inp.select;this.index=this.select[0].selectedIndex;if(typeof inp.index==="number"&&parseFloat(inp.index)==parseInt(inp.index)){this.index=inp.index;this.select[0].selectedIndex=this.index}this.updateOptsByIndex(this.index);this.callback={change:"",start:"",stop:"",mouseenter:"",context:(typeof inp.context==="object")?inp.context:this};if(typeof inp.change==="function"){this.callback.change=inp.change}if(typeof inp.start==="function"){this.callback.start=inp.start}if(typeof inp.stop==="function"){this.callback.stop=inp.stop}if(typeof inp.mouseenter==="function"){this.callback.mouseenter=inp.mouseenter}this.init();return this}ParameterSlider.prototype.updateOptsByIndex=function(i){this.opts=this.select.children().map(function(){return parseFloat($(this).val())}).get();var orig=this.index;this.index=(typeof i==="number")?i:0;this.value=this.opts[this.index];if(orig!=this.index){this.select[0].selectedIndex=this.index}};ParameterSlider.prototype.init=function(){var _obj=this;this.slider=$("<div id='"+_obj.select.attr("id")+"_slider'></div>").insertAfter(this.select).slider({animate:"fast",min:1,max:this.opts.length,range:"min",value:_obj.index+1,slide:function(event,ui){_obj.updateOptsByIndex(ui.value-1);if(typeof _obj.callback.change==="function"){_obj.callback.change.call(_obj.callback.context,{event:event,value:_obj.value,id:_obj.select.attr("id")})}},start:function(event,ui){if(typeof _obj.callback.start==="function"){_obj.callback.start.call(_obj.callback.context,{event:event,value:_obj.value,id:_obj.select.attr("id")})}},stop:function(event,ui){if(typeof _obj.callback.stop==="function"){_obj.callback.stop.call(_obj.callback.context,{event:event,value:_obj.value,id:_obj.select.attr("id")})}}});if(typeof _obj.callback.mouseenter==="function"){$("#"+_obj.select.attr("id")+"_slider").on("mouseenter",function(e){_obj.callback.mouseenter.call(_obj.callback.context,{event:e,value:_obj.value,id:_obj.select.attr("id")})});$("#"+_obj.select.attr("id")+"_slider a.ui-slider-handle").on("focus",function(e){_obj.callback.mouseenter.call(_obj.callback.context,{event:e,value:_obj.value,id:_obj.select.attr("id")})})}this.select.change(function(){_obj.slider.slider("value",this.selectedIndex+1)});this.select.hide()};ParameterSlider.prototype.change=function(){};ParameterSlider.prototype.setValue=function(v){this.opts=this.select.children().map(function(){return parseFloat($(this).val())}).get();for(var i=0;i<this.opts.length;i++){if(this.opts[i]==v){this.slider.slider("value",i+1);this.updateOptsByIndex(i);break}}return};function PowerSpectrum(inp){this.id=(is(inp.ps,"string"))?inp.ps:"powerspectrum";this.el=$("#"+this.id);this.dir=(is(inp.dir,"string"))?inp.dir:"db/";this.omega={b:"",c:"",l:""};this.fullscreen=false;this.logging=(console&&typeof console.log==="function");this.callback={updated:"",context:(typeof inp.context==="object")?inp.context:this};if(typeof inp.updated==="function"){this.callback.updated=inp.updated}this.chart={};this.setOptions();this.create();this.loadData("omega_b",inp.omega_b,inp.omega_c,inp.omega_l);this.el.toggleClass("hidden");$(window).on("resize",{me:this},function(ev){ev.data.me.resize()});return this}PowerSpectrum.prototype.setOptions=function(){var fs=parseInt(getStyle(this.id,"font-size"));var ff=getStyle(this.id,"font-family");var co=getStyle(this.id,"color");this.opts={"font-size":fs,font:fs+"px",offset:{top:(this.fullscreen?fs:1),left:(this.fullscreen?fs*2:fs*1.5),right:(this.fullscreen?fs:1),bottom:(this.fullscreen?fs*2:fs*1.5)},grid:{color:"rgb(0,0,0)",opacity:0.25,width:"0.5",sub:{color:"rgb(0,0,0)",opacity:0.08,width:"0.5"}},xaxis:{invert:true,min:1.5,max:3000,label:{color:co,font:ff},ticks:true},yaxis:{min:0,max:6500,label:{color:co,font:ff}}}};PowerSpectrum.prototype.resize=function(){this.el.children().hide();if(this.el.innerWidth()!=this.chart.width||this.el.innerHeight()!=this.chart.height){this.setOptions();this.create();this.draw()}this.el.children().show()};PowerSpectrum.prototype.create=function(){this.chart.width=this.el.innerWidth();this.chart.height=this.el.innerHeight();this.opts.offset.width=this.chart.width-this.opts.offset.right-this.opts.offset.left;this.opts.offset.height=this.chart.height-this.opts.offset.bottom-this.opts.offset.top;if(this.chart.holder){this.chart.holder.setSize(this.chart.width,this.chart.height)}else{this.chart.holder=Raphael(this.id,this.chart.width,this.chart.height);$("#"+this.id).on("dblclick",{me:this},function(e){e.data.me.toggleFullScreen()});$("#"+this.id).on("click",{me:this},function(e){e.data.me.draw()});$("#"+this.id).on("fullscreeneventchange",{me:this},function(e){e.data.me.updateFullScreen()});$(document).on("mozfullscreenchange",{me:this},function(e){e.data.me.updateFullScreen()})}var l=this.opts.offset.left,t=this.opts.offset.top,w=this.opts.offset.width,h=this.opts.offset.height,b=this.opts.offset.bottom;var ell=$("<div>").html("&#8467;").text();var deg=$("<div>").html("&deg;").text();if(this.chart.axes){this.chart.axes.attr({x:l+0.5,y:t-0.5,width:w,height:h})}else{this.chart.axes=this.chart.holder.rect(l,t,w,h).translate(0.5,-0.5).attr({stroke:"#AAAAAA","stroke-width":1})}if(this.chart.yLabel){this.chart.yLabel.attr({x:l*0.5,y:t+(h/2),transform:"","font-size":this.opts.font,fill:(this.opts.yaxis.label.color?this.opts.yaxis.label.color:"black")}).rotate(270,l*0.5,t+(h/2))}else{this.chart.yLabel=this.chart.holder.text(l*0.5,t+(h/2),"Anisotropy "+ell+"("+ell+"+1) C"+ell+"").attr({fill:(this.opts.yaxis.label.color?this.opts.yaxis.label.color:"black"),"font-size":this.opts.font,"font-family":this.opts.yaxis.label.font}).rotate(270)}if(this.chart.xLabel){this.chart.xLabel.attr({x:l+w/2,y:t+h+b*0.5,"font-size":this.opts.font,fill:(this.opts.yaxis.label.color?this.opts.yaxis.label.color:"black")})}else{this.chart.xLabel=this.chart.holder.text(l+w/2,t+h+b*0.5,"Spherical Harmonic "+ell).attr({fill:(this.opts.xaxis.label.color?this.opts.xaxis.label.color:"black"),"font-size":this.opts.font,"font-family":this.opts.xaxis.label.font})}if(this.opts.xaxis.ticks){var path=[];var txt=[];var deglabels=[30,10,3,1,0.3,0.1];var y,x,Xmin,Xmax,Xscale;Xmin=this.scaleX(this.opts.xaxis.min);Xmax=this.scaleX(this.opts.xaxis.max);Xscale=(this.opts.offset.width)/(Xmax-Xmin);for(var i=0;i<deglabels.length;i++){var l=180/deglabels[i];var fs=this.opts["font-size"]/2;y=(this.opts.offset.top+this.opts.offset.height);x=(this.opts.offset.left+Xscale*(this.scaleX(l)-Xmin));path=path.concat(["M",x,y,"L",x,y-fs]);txt.push([x,y-fs-fs,deglabels[i]+deg])}if(this.chart.xlines){this.chart.xlines.attr("path",path);for(var i=0;i<deglabels.length;i++){this.chart.xtext[i].attr({x:txt[i][0],y:txt[i][1],"font-size":fs})}}else{this.chart.xlines=this.chart.holder.path(path).attr({stroke:"#AAAAAA","stroke-width":1,"stroke-linejoin":"round"});this.chart.xtext=this.chart.holder.set();for(var i=0;i<deglabels.length;i++){this.chart.xtext.push(this.chart.holder.text(txt[i][0],txt[i][1],txt[i][2]).attr({fill:"black","text-anchor":"middle"}))}}}};PowerSpectrum.prototype.toggleTicks=function(){this.opts.xaxis.ticks=!this.opts.xaxis.ticks;if(this.opts.xaxis.ticks){this.chart.xlines.show();this.chart.xtext.show()}else{this.chart.xlines.hide();this.chart.xtext.hide()}};PowerSpectrum.prototype.scaleX=function(l){if(l>0){return Math.log(l*(l+1))}else{return 0}};PowerSpectrum.prototype.scaleY=function(l,cl){return cl};PowerSpectrum.prototype.draw=function(){if(!this.chart.holder){return this}if(this.logging){var d=new Date()}if(this.data){var p,max,y,x,x1,prevy,tempx,tempy,data,peak,trough,Xmin,Xmax,Ymin,Ymax,Yrange,Yscale,Xrange,Xscale;max=0;data=this.data;Xmin=this.scaleX(this.opts.xaxis.min);Xmax=this.scaleX(this.opts.xaxis.max);Xrange=(Xmax-Xmin);Xscale=(this.opts.offset.width)/Xrange;Ymin=this.scaleY(this.opts.xaxis.min,this.opts.yaxis.min);Ymax=this.scaleY(this.opts.xaxis.max,this.opts.yaxis.max);Yrange=(Ymax-Ymin);Yscale=(this.opts.offset.height)/Yrange;this.firsttrough=0;this.firstpeak=0;for(var i=0,j=0;i<data[0].length;i++){tempy=this.scaleY(data[0][i],data[1][i]);tempx=this.scaleX(data[0][i]);y=(this.opts.offset.top+this.opts.offset.height-Yscale*(tempy-Ymin)).toFixed(2);x=(this.opts.offset.left+Xscale*(tempx-Xmin)).toFixed(2);if(i==0){p=["M",x,y,"R"]}else{if(i>0&&i<data[0].length-1){trough=(data[1][i-1]>data[1][i]&&data[1][i+1]>data[1][i]);peak=(data[1][i-1]<data[1][i]&&data[1][i+1]<data[1][i]);if(data[0][i]>100&&(trough||peak)){if(peak&&!this.firstpeak){this.firstpeak=data[0][i]}if(trough&&this.firstpeak&&!this.firsttrough){this.firsttrough=data[0][i]}if(this.firsttrough==data[0][i]){tempx=this.scaleX(data[0][i-1]+(data[0][i]-data[0][i-1])*0.25);x1=this.opts.offset.left+Xscale*(tempx-Xmin);tempx=this.scaleX(data[0][i]-(data[0][i]-data[0][i-1])*0.25);x2=this.opts.offset.left+Xscale*(tempx-Xmin);p=p.concat(["C",x1.toFixed(2),prevy,x2.toFixed(2),y])}else{tempx=this.scaleX(data[0][i]-(data[0][i]-data[0][i-1])*0.25);x1=this.opts.offset.left+Xscale*(tempx-Xmin);p=p.concat(["S",x1.toFixed(2),y])}}}p=p.concat([x,y]);prevy=y}if(tempy>max){max=tempy}}var clip=(this.opts.offset.left+0.5)+","+(this.opts.offset.top-0.5)+","+this.opts.offset.width+","+this.opts.offset.height;if(this.chart.line){this.chart.line.attr({"clip-rect":clip,path:p})}else{this.chart.line=this.chart.holder.path(p).attr({stroke:"#E13F29","stroke-width":3,"stroke-linejoin":"round","clip-rect":clip})}}return this};PowerSpectrum.prototype.toggle=function(){this.el.toggleClass("hidden");$("body").toggleClass("adv");this.resize()};PowerSpectrum.prototype.toggleFullScreen=function(){if(fullScreenApi.supportsFullScreen){var el=document.getElementById(this.id);if(fullScreenApi.isFullScreen()){fullScreenApi.cancelFullScreen(el)}else{fullScreenApi.requestFullScreen(el)}}};PowerSpectrum.prototype.updateFullScreen=function(){if(fullScreenApi.isFullScreen()){this.fullscreen=true;$("body").addClass("fullscreen")}else{this.fullscreen=false;$("body").removeClass("fullscreen")}this.setOptions();this.create();this.draw()};PowerSpectrum.prototype.loadData=function(id,b,c,l,fn){var file="";if(id=="omega_b"){file=this.dir+"Ob_Oc"+c.toFixed(2)+"_Ol"+l.toFixed(2)+"_lin.json"}else{if(id=="omega_c"){file=this.dir+"Ob"+b.toFixed(2)+"_Oc_Ol"+l.toFixed(2)+"_lin.json"}else{if(id=="omega_l"){file=this.dir+"Ob"+b.toFixed(2)+"_Oc"+c.toFixed(2)+"_Ol_lin.json"}}}if(!file||file==this.lastload){this.getData(id,b,c,l);return}if(this.logging){console.log("Getting "+file+" for "+id)}var _obj=this;this.json="";$.ajaxSetup({async:false,beforeSend:function(xhr){if(xhr.overrideMimeType){xhr.overrideMimeType("text/plain")}}});$.ajax({dataType:"json",url:file,context:_obj,success:function(data){this.json=data;this.getData(id,b,c,l)},error:function(e){this.callback.context.error("We couldn't load the CMB fluctuations of this universe (&Omega;<sub>b</sub> = "+b+", &Omega;<sub>c</sub> = "+c+", &Omega;<sub>&Lambda;</sub> = "+l+"). That sucks. :-(");if(this.logging){console.log(file)}},timeout:4000});this.lastload=file};PowerSpectrum.prototype.getData=function(id,b,c,l){if(b==this.omega.b&&c==this.omega.c&&l==this.omega.l){return}this.firstpeak=0;this.omega={b:b,c:c,l:l};if(this.json){if(this.json.extrema&&this.json.extrema.length>1){var i,j,data,val;val=(id=="omega_b"?b:(id=="omega_c"?c:l));for(i=0;i<this.json.extrema.length;i++){if(this.json.extrema[i][0]==val){break}}if(i>=this.json.extrema.length){this.callback.context.error("Oh dear. We couldn't find the CMB fluctuations for this universe (&Omega;<sub>b</sub> = "+b+", &Omega;<sub>c</sub> = "+c+", &Omega;<sub>&Lambda;</sub> = "+l+")")}else{data=new Array(this.json.extrema[i].length);for(j=0;j<this.json.extrema[i].length;j++){data[j]=this.json.extrema[i][j]+0}}if(data){data.shift();n=data.length/2;x=new Array(n);y=new Array(n);for(var i=0;i<n;i++){x[i]=data[i*2];y[i]=data[i*2+1]}data=[x,y];this.data=data}else{this.data=[[1,2500],[1,1]]}this.draw()}}else{this.error("Something went wrong with the universe (&Omega;<sub>b</sub> = "+b+", &Omega;<sub>c</sub> = "+c+", &Omega;<sub>&Lambda;</sub> = "+l+")")}if(typeof this.callback.updated==="function"){this.callback.updated.call(this.callback.context,{firstpeak:this.firstpeak})}};Simulator.prototype.error=function(txt){$("#error").html('<a class="close">&times;</a>'+txt).show().data("omega_b",this.omega_b.value).data("omega_c",this.omega_c.value).data("omega_l",this.omega_l.value);$("#error .close").on("click",function(e){$(this).parent().hide()});return};Simulator.prototype.warning=function(txt){$("#warning").html('<a class="close">&times;</a>'+txt).show();$("#warning .close").on("click",function(e){$(this).parent().hide()});return};function Canvas(i){if(!(typeof i=="string"||(typeof i=="object"&&typeof i.id=="string"))){return}this.id="";this.canvas="";this.c="";this.wide=0;this.tall=0;this.fullscreen=false;this.fullwindow=false;this.transparent=false;this.color="";this.background="rgb(255,255,255)";this.events={resize:""};this.ie=false;this.excanvas=(typeof G_vmlCanvasManager!="undefined")?true:false;
/*@cc_on
		this.ie = true
		@*/
var n="number";var s="string";var b="boolean";var o="object";var f="function";if(is(i.id,s)){this.id=i.id}if(is(i.background,s)){this.background=i.background}if(is(i.color,s)){this.color=i.color}if(is(i.width,n)){this.wide=i.width}if(is(i.height,n)){this.tall=i.height}if(is(i.fullwindow,b)){this.fullwindow=i.fullwindow}if(is(i.transparent,b)){this.transparent=i.transparent}if(!this.id){return}this.container=$("#"+this.id);if(this.container.length==0){$("body").append('<div id="'+this.id+'"></div>');this.container=$("#"+this.id)}this.container.css("position","relative");if(typeof Object.extend==="undefined"){this.extend=function(destination,source){for(var property in source){if(source.hasOwnProperty(property)){destination[property]=source[property]}}return destination}}else{this.extend=Object.extend}this.container.html('<canvas id="'+this.id+'inner"></canvas>');this.containerbg=this.container.css("background");this.canvas=$("#"+this.id+"inner");this.c=document.getElementById(this.id+"inner");if(this.wide>0){this.c.width=this.wide}if(this.tall>0){this.c.height=this.tall}if(this.excanvas){this.c=G_vmlCanvasManager.initElement(this.c)}if(this.c&&this.c.getContext){this.ctx=this.c.getContext("2d");this.ctx.clearRect(0,0,this.wide,this.tall);this.ctx.beginPath();var fs=parseInt(getStyle(this.id,"font-size"));this.ctx.font=fs+"px "+getStyle(this.id,"font-family");this.ctx.fillStyle=getStyle(this.id,"color");this.ctx.lineWidth=1.5;var loading="Loading sky...";this.ctx.fillText(loading,(this.wide-this.ctx.measureText(loading).width)/2,(this.tall)/2);this.ctx.fill()}if(fullScreenApi.supportsFullScreen){this.canvas.bind("dblclick",{me:this},function(e){e.data.me.toggleFullScreen()})}this.canvas.bind("mousedown",{me:this},function(e){e.data.me.trigger("mousedown",{event:e})});this.canvas.bind("mousemove",{me:this},function(e){e.data.me.trigger("mousemove",{event:e})});this.canvas.bind("mouseup",{me:this},function(e){e.data.me.trigger("mouseup",{event:e})})}Canvas.prototype.bind=function(ev,e,fn){if(typeof ev!="string"){return this}if(is(fn,"undefined")){fn=e;e={}}else{e={data:e}}if(typeof e!="object"||typeof fn!="function"){return this}if(this.events[ev]){this.events[ev].push({e:e,fn:fn})}else{this.events[ev]=[{e:e,fn:fn}]}return this};Canvas.prototype.trigger=function(ev,args){if(typeof ev!="string"){return}if(typeof args!="object"){args={}}var o=[];if(typeof this.events[ev]=="object"){for(var i=0;i<this.events[ev].length;i++){var e=this.extend(this.events[ev][i].e,args);if(typeof this.events[ev][i].fn=="function"){o.push(this.events[ev][i].fn.call(this,e))}}}if(o.length>0){return o}};Canvas.prototype.copyToClipboard=function(){try{this.clipboard=this.ctx.getImageData(0,0,this.wide,this.tall);this.clipboardData=this.clipboard.data}catch(e){this.clipboard=null}};Canvas.prototype.pasteFromClipboard=function(){if(this.clipboardData&&this.clipboard){this.clipboard.data=this.clipboardData;this.ctx.putImageData(this.clipboard,0,0)}};Canvas.prototype.toggleFullScreen=function(){if(fullScreenApi.supportsFullScreen){this.elem=document.getElementById(this.id);if(fullScreenApi.isFullScreen()){fullScreenApi.cancelFullScreen(this.elem);this.fullscreen=false}else{fullScreenApi.requestFullScreen(this.elem);this.fullscreen=true}}};function Sky(inp){this.id=(is(inp.map,"string"))?inp.map:"map";this.el=$("#"+this.id);this.dir=(is(inp.dir,"string"))?inp.dir:"db/";this.context=(is(inp.context,"object"))?inp.context:this;this.loaded=false;this.logging=true;this.sluggish=false;this.fixedscale=true;this.showours=true;this.showscale=true;this.w=256,this.h=256,this.maxang=10;this.minang=this.maxang/this.w;this.dl=360/this.maxang;this.re=[];this.im=[];this.src="";this.our=new Image();this.our.src=this.el.find("img.our").attr("src");this.canvas=new Canvas({id:this.id,width:this.w,height:this.h});this.spectrum={};this.spectrum.el=document.getElementById("spectrum");this.spectrum.el.width=this.w;this.spectrum.el.height=this.h;this.spectrum.ctx=this.spectrum.el.getContext("2d");this.spectrum.ctx.fillStyle="#ffffff";this.spectrum.ctx.fillRect(0,0,this.w,this.h);this.el.append('<div class="label sim">Current universe</div><div class="label our">Our universe</div><div class="label scale"><div class="value">1&deg;</div></div>');FFT.init(this.w);FrequencyFilter.init(this.w,this.dl);SpectrumViewer.init(this.spectrum.ctx);this.load()}Sky.prototype.load=function(){this.loaded=true;this.setupFFT();this.update();this.resize();return this};Sky.prototype.setupFFT=function(){if(this.logging){var d=new Date()}this.src=this.spectrum.ctx.getImageData(0,0,this.w,this.h);this.data=this.src.data;var z=new Ziggurat(-1);var twopi=2*Math.PI;var i=0,y,x;for(y=0;y<this.h;y++){i=y*this.w;for(x=0;x<this.w;x++){this.re[i+x]=z.nextGaussian();this.im[i+x]=0}}FFT.fft2d(this.re,this.im);this.setColourTable("planck");if(new Date()-d>1000){this.sluggish=true}if(this.logging){console.log("Total for Sky.prototype.setupFFT(): "+(new Date()-d)+"ms")}if(this.sluggish){this.context.warning("It may take time to update the universe. Please be patient.")}else{$("#warning").hide()}return this};Sky.prototype.setColourTable=function(ct){this.colours=new colourtable(ct)};Sky.prototype.resize=function(){};Sky.prototype.update=function(){var d=new Date();try{var val=0,p=0,x,y,scale,re,im,mx,mn;re=this.re.slice(0);im=this.im.slice(0);if(this.context.ps.data[0].length==2){this.canvas.ctx.fillStyle="#ffffff";this.canvas.ctx.fillRect(0,0,this.w,this.h);$(".labels").hide();return}else{if(!$(".labels").is(":visible")){$(".labels").show()}}FrequencyFilter.swap(re,im);FrequencyFilter.filter(re,im,this.context.ps.data);SpectrumViewer.render(re,im,false);FrequencyFilter.swap(re,im);FFT.ifft2d(re,im);if(this.fixedscale){mx=0.11;mn=-0.11}else{mx=Math.max.apply(null,re);mn=Math.min.apply(null,re)}scale=255/(mx-mn);for(y=0,i=0;y<this.h;y++,i+=this.w){for(x=0;x<this.w;x++){val=(re[i+x]-mn)*scale;val=val>255?255:val<0?0:val;p=(i<<2)+(x<<2);val=Math.round(val);this.data[p]=this.colours[val][0];this.data[p+1]=this.colours[val][1];this.data[p+2]=this.colours[val][2]}}this.canvas.ctx.putImageData(this.src,0,0);if(this.showours){this.canvas.ctx.save();this.canvas.ctx.beginPath();this.canvas.ctx.moveTo(this.w,0);this.canvas.ctx.lineTo(this.w*0.4,0);this.canvas.ctx.lineTo(this.w,this.h*0.6);this.canvas.ctx.lineTo(this.w,0);this.canvas.ctx.clip();this.canvas.ctx.drawImage(this.our,0,0,this.w,this.h);this.canvas.ctx.restore();this.canvas.ctx.beginPath();this.canvas.ctx.moveTo(this.w*0.4,0);this.canvas.ctx.lineTo(this.w,this.h*0.6);this.canvas.ctx.strokeStyle="#fff";this.canvas.ctx.stroke()}}catch(e){if(this.logging){console.log(e,p,val,re[i+x],i,x)}}if(this.logging){console.log("Total for Sky.prototype.update():"+(new Date()-d)+"ms")}};var FFT=(function(){var _n=0,_bitrev=null,_cstb=null,_init=function(n){if(n!==0&&(n&(n-1))===0){_n=n;_setVariables();_makeBitReversal();_makeCosSinTable()}else{throw new Error("init: radix-2 required")}},_fft1d=function(re,im){_fft(re,im,1)},_ifft1d=function(re,im){var n=1/_n;_fft(re,im,-1);for(var i=0;i<_n;i++){re[i]*=n;im[i]*=n}},_fft2d=function(re,im){var x,x1,x2,y,y1,y2;var tre=[],tim=[],i=0;for(y=0,i=0;y<_n;y++,i+=_n){for(x1=0;x1<_n;x1++){tre[x1]=re[x1+i];tim[x1]=im[x1+i]}_fft1d(tre,tim);for(x2=0;x2<_n;x2++){re[x2+i]=tre[x2];im[x2+i]=tim[x2]}}for(x=0,i=0;x<_n;x++){for(y1=0;y1<_n;y1++){i=x+y1*_n;tre[y1]=re[i];tim[y1]=im[i]}_fft1d(tre,tim);for(y2=0;y2<_n;y2++){i=x+y2*_n;re[i]=tre[y2];im[i]=tim[y2]}}},_ifft2d=function(re,im){var tre=[],tim=[],i=0;var x,x1,x2,y,y1,y2;for(y=0;y<_n;y++,i+=_n){for(x1=0;x1<_n;x1++){tre[x1]=re[x1+i];tim[x1]=im[x1+i]}_ifft1d(tre,tim);for(x2=0;x2<_n;x2++){re[x2+i]=tre[x2];im[x2+i]=tim[x2]}}for(x=0;x<_n;x++){i=x;for(y1=0;y1<_n;y1++,i+=_n){tre[y1]=re[i];tim[y1]=im[i]}_ifft1d(tre,tim);i=x;for(y2=0;y2<_n;y2++,i+=_n){re[i]=tre[y2];im[i]=tim[y2]}}},_fft=function(re,im,inv){var d,h,ik,m,tmp,wr,wi,xr,xi,n4=_n>>2;var k,j,i;for(var l=0;l<_n;l++){m=_bitrev[l];if(l<m){tmp=re[l];re[l]=re[m];re[m]=tmp;tmp=im[l];im[l]=im[m];im[m]=tmp}}for(k=1;k<_n;k<<=1){h=0;d=_n/(k<<1);for(j=0;j<k;j++){wr=_cstb[h+n4];wi=inv*_cstb[h];for(i=j;i<_n;i+=(k<<1)){ik=i+k;xr=wr*re[ik]+wi*im[ik];xi=wr*im[ik]-wi*re[ik];re[ik]=re[i]-xr;re[i]+=xr;im[ik]=im[i]-xi;im[i]+=xi}h+=d}}},_setVariables=function(){_bitrev=[];_cstb=[]},_makeBitReversal=function(){var i=0,j=0,k=0;_bitrev[0]=0;while(++i<_n){k=_n>>1;while(k<=j){j-=k;k>>=1}j+=k;_bitrev[i]=j}},_makeCosSinTable=function(){var n2=_n>>1,n4=_n>>2,n8=_n>>3,n2p4=n2+n4,t=Math.sin(Math.PI/_n),dc=2*t*t,ds=Math.sqrt(dc*(2-dc)),c=_cstb[n4]=1,s=_cstb[0]=0;t=2*dc;for(var i=1;i<n8;i++){c-=dc;dc+=t*c;s+=ds;ds-=t*s;_cstb[i]=s;_cstb[n4-i]=c}if(n8!==0){_cstb[n8]=Math.sqrt(0.5)}for(var j=0;j<n4;j++){_cstb[n2-j]=_cstb[j]}for(var k=0;k<n2p4;k++){_cstb[k+n2]=-_cstb[k]}};return{init:_init,fft:_fft1d,ifft:_ifft1d,fft1d:_fft1d,ifft1d:_ifft1d,fft2d:_fft2d,ifft2d:_ifft2d}})();var FrequencyFilter=(function(){var _n=0,_ls=[],_llpo=[],_init=function(n,dl){if(n!==0&&(n&(n-1))===0){_n=n}else{throw new Error("init: radix-2 required")}var i=0,p;var n2=_n>>1;if(!dl||typeof dl!=="number"){dl=0}var _rs=[];for(var y=-n2;y<n2;y++){i=n2+(y+n2)*_n;for(var x=-n2;x<n2;x++){p=x+i;_rs[p]=Math.sqrt(((x*x)+(y*y)));if(_rs[p]==0){_ls[p]=dl}else{_ls[p]=_rs[p]*dl}_llpo[p]=_ls[p]*(_ls[p]+1)}}},_swap=function(re,im){var xn,yn,i,j,k,l,tmp,len=_n>>1;for(var y=0;y<len;y++){yn=y+len;for(var x=0;x<len;x++){xn=x+len;i=x+y*_n;j=xn+yn*_n;k=x+yn*_n;l=xn+y*_n;tmp=re[i];re[i]=re[j];re[j]=tmp;tmp=re[k];re[k]=re[l];re[l]=tmp;tmp=im[i];im[i]=im[j];im[j]=tmp;tmp=im[k];im[k]=im[l];im[l]=tmp}}},_filter=function(re,im,data){var i=0,v=0;p=0,x=0,y=0,z=0,n2=_n>>1;for(y=-n2;y<n2;y++){i=n2+(y+n2)*_n;for(x=-n2;x<n2;x++){p=x+i;for(z=0;z<data[0].length;z++){if(_ls[p]>data[0][data[0].length-1]){v=data[1][data[0].length-1];break}else{if(data[0][z]>_ls[p]){v=(z==0)?data[1][z]:(data[1][z-1]+(data[1][z]-data[1][z-1])*(_ls[p]-data[0][z-1])/(data[0][z]-data[0][z-1]));break}}}v/=_llpo[p];v=Math.sqrt(v);re[p]*=v;im[p]*=v}}},_setFilter=function(f){if(typeof f==="function"){_filter=f}};return{init:_init,swap:_swap,filter:_filter,setFilter:_setFilter}})();var SpectrumViewer=(function(){var _context=null,_n=0,_img=null,_data=null,_init=function(context){_context=context;_n=context.canvas.width,_img=context.getImageData(0,0,_n,_n);_data=_img.data},_render=function(re,im,islog){var val=0,i=0,p=0,spectrum=[],max=1,imax=0,n2=_n*_n;for(var i=0;i<n2;i++){if(islog){spectrum[i]=Math.log(Math.sqrt(re[i]*re[i]+im[i]*im[i]))}else{spectrum[i]=Math.sqrt(re[i]*re[i]+im[i]*im[i])}if(spectrum[i]>max){max=spectrum[i]}}imax=1/max;for(var j=0;j<n2;j++){spectrum[j]=spectrum[j]*255*imax}for(var y=0;y<_n;y++){i=y*_n;for(var x=0;x<_n;x++){val=spectrum[i+x];p=(i<<2)+(x<<2);_data[p]=0;_data[p+1]=val;_data[p+2]=val>>1}}_context.putImageData(_img,0,0)};return{init:_init,render:_render}})();function Simulator(inp){this.previous={omega_b:-1,omega_c:-1,omega_l:-1};$(".scriptonly").removeClass("scriptonly");if(!inp){inp={}}var change=function(e){this.ps.getData(e.id,this.omega_b.value,this.omega_c.value,this.omega_l.value)},mouseenter=function(e){this.ps.loadData(e.id,this.omega_b.value,this.omega_c.value,this.omega_l.value)};var _obj=this;this.omega_b=new ParameterSlider({select:$("#"+((inp.omega_b&&typeof inp.omega_b==="string")?inp.omega_b:"omega_b")),context:_obj,change:change,mouseenter:mouseenter});this.omega_c=new ParameterSlider({select:$("#"+((inp.omega_c&&typeof inp.omega_c==="string")?inp.omega_c:"omega_c")),context:_obj,change:change,mouseenter:mouseenter});this.omega_l=new ParameterSlider({select:$("#"+((inp.omega_l&&typeof inp.omega_l==="string")?inp.omega_l:"omega_l")),context:_obj,change:change,mouseenter:mouseenter});inp.omega_b=this.omega_b.value;inp.omega_c=this.omega_c.value;inp.omega_l=this.omega_l.value;this.our={omega_b:0.05,omega_c:0.25,omega_l:0.7};if(location.hash.substring(1)!="about"){$("#help").addClass("on");$("#about").hide()}this.cosmos=new Cosmos(inp.omega_b,inp.omega_c,inp.omega_l);inp.context=this;inp.updated=function(e){if(this.sky){_obj.update(e);this.sky.update()}};this.ps=new PowerSpectrum(inp);this.sky=new Sky(inp);$("#options").append($('<a class="button ouruniverse" href="#">Our universe</a>').on("click",{me:this},function(e){e.preventDefault();var sim=e.data.me;sim.omega_b.setValue(sim.our.omega_b);sim.omega_c.setValue(sim.our.omega_c);sim.omega_l.setValue(sim.our.omega_l);sim.ps.loadData("omega_b",sim.omega_b.value,sim.omega_c.value,sim.omega_l.value)}),$('<a class="button matteronly" href="#">Normal matter only</a>').on("click",{me:this},function(e){e.preventDefault();var sim=e.data.me;sim.omega_b.setValue(0.2);sim.omega_c.setValue(0);sim.omega_l.setValue(0);sim.ps.loadData("omega_b",sim.omega_b.value,sim.omega_c.value,sim.omega_l.value)}),$('<a class="button flatten" href="#">Flatten</a>').on("click",{me:this},function(e){e.preventDefault();var sim=e.data.me;var ob=sim.omega_b.value;var oc=sim.omega_c.value;var ol=sim.omega_l.value;var tot=(ob+oc+ol).toFixed(2);if(tot>1){if(ob+oc<=1){sim.omega_l.setValue((1-oc-ob).toFixed(2))}else{sim.omega_c.setValue((1-ob).toFixed(2));sim.omega_l.setValue(0)}}else{if(tot<1){if(ob+oc<=1){sim.omega_b.setValue((1-oc-ol).toFixed(2))}else{sim.omega_c.setValue((1-ob).toFixed(2))}}}sim.ps.loadData("omega_b",sim.omega_b.value,sim.omega_c.value,sim.omega_l.value)}));$("#config form").append('<div class="configoption"><input type="checkbox" name="showscale" /><label for="showscale">Show angular scale</label></a></div><div class="configoption"><input type="checkbox" name="showours" /><label for="showours">Show our universe</label></a></div><div class="configoption"><input type="checkbox" name="normscale" /><label for="normscale">Normalise colour scale</label></div><!--<div class="configoption"><label for="colourtable">Colour scheme</label>: <select name="colourtable" id="colourtable"><option value="planck">Planck</option><option value="blackbody">Heat</option><option value="A">A</option><option value="B">B</option></select></div>-->');$("#config form input[name=showscale]").attr("checked",this.sky.showscale).on("click",{me:this},function(e){var sim=e.data.me;sim.sky.showscale=$(this).is(":checked");sim.ps.toggleTicks();sim.update()});$("#config form input[name=showours]").attr("checked",this.sky.showours).on("click",{me:this},function(e){var sim=e.data.me;sim.sky.showours=$(this).is(":checked");sim.sky.update();sim.update()});$("#config form input[name=normscale]").attr("checked",!this.sky.fixedscale).on("click",{me:this},function(e){var sim=e.data.me;sim.sky.fixedscale=!$(this).is(":checked");sim.sky.update();sim.update()});$("#config form select").on("change",{me:this},function(e){e.data.me.sky.setColourTable($(this).val());e.data.me.sky.update();e.data.me.update()});$("label").on("click",{me:this},function(e){var labelID=$(this).attr("for");$("#config form input[name="+labelID+"]").trigger("click")});$(document).bind("keypress",{sim:this},function(e){if(!e){e=window.event}sim=e.data.sim;var code=e.keyCode||e.charCode||e.which||0;var c=String.fromCharCode(code).toLowerCase();if(c=="a"){sim.ps.toggle()}else{if(c=="b"){sim.omega_b.slider.find(".ui-slider-handle").focus()}else{if(c=="c"){sim.omega_c.slider.find(".ui-slider-handle").focus()}else{if(c=="l"){sim.omega_l.slider.find(".ui-slider-handle").focus()}else{if(c=="i"){window.location.href=switchHash()}else{if(c=="f"){sim.ps.toggleFullScreen()}}}}}}});$(window).bind("resize",{me:this},function(ev){ev.data.me.resize()});function switchHash(){if(location.hash.substring(1)=="about"){return"#"}else{return"#about"}}var lasttoggle=new Date();function toggleAbout(key){var now=new Date();if(now-lasttoggle>500){$("#help").toggleClass("on");if($("#help").hasClass("on")){$("#about").slideDown()}else{$("#about").slideUp()}}lasttoggle=now;return true}var hashstate="";setInterval(function(){if(location.hash.substring(1)=="about"&&!$("#help").hasClass("on")){toggleAbout()}if(location.hash.substring(1)!="about"&&$("#help").hasClass("on")){toggleAbout()}},500);var newdiv=$('<div id="menu"><div id="help" class="toggle"><a href="#about" class="abouton">i</a><a href="#" class="aboutoff">&#8679;</a></div><div id="advancedtoggle" class="toggle"><a href="#powerspectrum"><img src="media/img/cleardot.gif" alt="Plot" title="Toggle power spectrum plot" /></a></div><div id="configtoggle" class="toggle"><a href="#config"><img src="media/img/cleardot.gif" alt="Options" title="Toggle options" /></a></div></div>');$("h1").before(newdiv);$("#help .abouton a, #help .aboutoff a").on("click",toggleAbout);$("#advancedtoggle a").on("click",{me:this},function(e){e.preventDefault();e.data.me.ps.toggle();return true});$("#configtoggle").on("click",{me:this},function(e){lightbox($("#config"),$("#configtoggle"))});this.update();return this}Simulator.prototype.resize=function(){this.ps.resize();this.sky.resize();this.update();return this};Simulator.prototype.update=function(e){if($("#map")&&this.sky){var v=Math.round(this.sky.canvas.canvas.outerWidth()/this.sky.maxang)+"px";var p=((this.sky.canvas.container.outerWidth()-this.sky.canvas.canvas.outerWidth())/2)+"px";$("#map .label.scale").css({"margin-right":p,width:v,height:v,"line-height":v,"border-radius":v});$("#map .label.sim").css("margin-left",p);$("#map .label.our").css("margin-right",p);if(this.sky.showscale){$("#map .label.scale").show()}else{$("#map .label.scale").hide()}if(this.sky.showours){$(".label.our").show()}else{$(".label.our").hide()}}if(this.previous.omega_b==this.omega_b.value&&this.previous.omega_c==this.omega_c.value&&this.previous.omega_l==this.omega_l.value){return this}else{this.previous={omega_b:this.omega_b.value,omega_c:this.omega_c.value,omega_l:this.omega_l.value}}if($("#error")){if($("#error").data("omega_b")!=this.omega_b.value||$("#error").data("omega_c")!=this.omega_c.value||$("#error").data("omega_l")!=this.omega_l.value){$("#error").hide()}}if($("#firstpeak")){var ang=180/this.ps.firstpeak;if(this.ps.firstpeak>0){$("#firstpeak").html('First peak at <span class="property">&#8467; = '+this.ps.firstpeak+"</span> (~"+(ang>0.5?ang.toFixed(1):ang.toFixed(2))+"&deg;)")}else{$("#firstpeak").html("No fluctuations in the CMB"+(this.omega_b.value==0?" because there<br />was no matter to interact with the photons.":""))}}else{$("#firstpeak").html("?")}if($("#age")){this.cosmos.compute(this.omega_b.value,this.omega_c.value,this.omega_l.value);$("#age").html('<span class="age property">'+this.cosmos.age_Gyr.toFixed(1)+"</span> billion years old")}if($("#curvature")){var tot=this.omega_b.value+this.omega_c.value+this.omega_l.value;$("#curvature").html('<span class="property curvature">'+((tot>1)?"closed":(tot<1)?"open":"flat")+"</span> universe");if(tot==1){$(".button.flatten").hide()}else{$(".button.flatten").show()}}$("span.omega_b").html(" = "+this.omega_b.value);$("span.omega_c").html(" = "+this.omega_c.value);$("span.omega_l").html(" = "+this.omega_l.value);return this};function Cosmos(b,c,l){this.n=1000;this.nda=1;this.H0=67.8;this.WM=b+c;this.WV=l;this.WR=0;this.WK=0;this.z=3;this.h=this.H0/100;this.c=299792.458;this.Tyr=977.8;this.DTT=0.5;this.DTT_Gyr=0;this.age=0.5;this.age_Gyr=0;this.zage=0.1;this.zage_Gyr=0;this.DCMR=0;this.DCMR_Mpc=0;this.DCMR_Gyr=0;this.a=1;this.az=0.5;this.compute(b,c,l);return this}Cosmos.prototype.compute=function(b,c,l){this.WM=b+c;this.WV=l;this.h=this.H0/100;this.WR=0.00004165/(this.h*this.h);this.WK=1-this.WM-this.WR-this.WV;this.az=1/(1+1*this.z);this.age=0;for(i=0;i!=this.n;i++){this.a=this.az*(i+0.5)/this.n;this.adot=Math.sqrt(this.WK+(this.WM/this.a)+(this.WR/(this.a*this.a))+(this.WV*this.a*this.a));this.age=this.age+1/this.adot}this.zage=this.az*this.age/this.n;var lpz=Math.log((1+1*this.z))/Math.log(10);var dzage=0;if(lpz>7.5){dzage=0.002*(lpz-7.5)}if(lpz>8){dzage=0.014*(lpz-8)+0.001}if(lpz>8.5){dzage=0.04*(lpz-8.5)+0.008}if(lpz>9){dzage=0.02*(lpz-9)+0.028}if(lpz>9.5){dzage=0.019*(lpz-9.5)+0.039}if(lpz>10){dzage=0.048}if(lpz>10.775){dzage=0.035*(lpz-10.775)+0.048}if(lpz>11.851){dzage=0.069*(lpz-11.851)+0.086}if(lpz>12.258){dzage=0.461*(lpz-12.258)+0.114}if(lpz>12.382){dzage=0.024*(lpz-12.382)+0.171}if(lpz>13.055){dzage=0.013*(lpz-13.055)+0.188}if(lpz>14.081){dzage=0.013*(lpz-14.081)+0.201}if(lpz>15.107){dzage=0.214}this.zage=this.zage*Math.pow(10,dzage);this.zage_Gyr=(this.Tyr/this.H0)*this.zage;this.DTT=0;this.DCMR=0;for(i=0;i!=this.n;i++){this.a=this.az+(1-this.az)*(i+0.5)/this.n;this.adot=Math.sqrt(this.WK+(this.WM/this.a)+(this.WR/(this.a*this.a))+(this.WV*this.a*this.a));this.DTT=this.DTT+1/this.adot;this.DCMR=this.DCMR+1/(this.a*this.adot)}this.DTT=(1-this.az)*this.DTT/this.n;this.DCMR=(1-this.az)*this.DCMR/this.n;this.age=this.DTT+this.zage;this.age_Gyr=this.age*(this.Tyr/this.H0);this.DTT_Gyr=(this.Tyr/this.H0)*this.DTT;this.DCMR_Gyr=(this.Tyr/this.H0)*this.DCMR;this.DCMR_Mpc=(this.c/this.H0)*this.DCMR};function colourtable(type){var table=new Array(256);for(var i=0;i<table.length;i++){table[i]=colour(i,type)}return table}function colour(v,type){if(type=="blackbody"||type=="heat"){return[((v<=127.5)?v*2:255),((v>63.75)?((v<191.25)?(v-63.75)*2:255):0),((v>127.5)?(v-127.5)*2:0)]}else{if(type=="A"){return[((v<=63.75)?0:((v<=127.5)?(v-63.75)*4:255)),((v<=63.75)?v*4:((v<=127.5)?(127.5-v)*4:((v<191.25)?0:(v-191.25)*4))),((v<31.875)?0:((v<127.5)?(v-31.875)*8/3:((v<191.25)?(191.25-v)*4:0)))]}else{if(type=="B"){return[((v<=63.75)?0:((v<=127.5)?(v-63.75)*4:255)),((v<=127.5)?0:((v<=191.25)?(v-127.5)*4:255)),((v<63.75)?v*4:((v<127.5)?(127.5-v)*4:((v<191.25)?0:(v-191.25)*4)))]}else{var dv,dr,dg,db,rgb;if(v<42){dv=v/42;rgb=[0,0,255];dr=0;dg=112;db=0}else{if(v>=42&&v<85){dv=(v-42)/43;rgb=[0,112,255];dr=0;dg=109;db=0}else{if(v>=85&&v<127){dv=(v-85)/42;rgb=[0,221,255];dr=255;dg=16;db=-38}else{if(v>=127&&v<170){dv=(v-127)/43;rgb=[255,237,217];dr=0;dg=-57;db=-217}else{if(v>=170&&v<212){dv=(v-170)/42;rgb=[255,180,0];dr=0;dg=-105;db=0}else{if(v>=212){dv=(v-212)/43;rgb=[255,75,0];dr=-155;dg=-75;db=0}}}}}}return[Math.round(rgb[0]+dv*dr),Math.round(rgb[1]+dv*dg),Math.round(rgb[2]+dv*db)]}}}}function is(a,b){return(typeof a==b)?true:false}function getStyle(el,styleProp){if(typeof window==="undefined"){return}var style;var el=document.getElementById(el);if(el&&el.currentStyle){style=el.currentStyle[styleProp]}else{if(window.getComputedStyle){style=document.defaultView.getComputedStyle(el,null).getPropertyValue(styleProp)}}if(style&&style.length===0){style=null}return style}var fullScreenApi={supportsFullScreen:false,isFullScreen:function(){return false},requestFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",prefix:""},browserPrefixes="webkit moz o ms khtml".split(" ");if(typeof document.cancelFullScreen!="undefined"){fullScreenApi.supportsFullScreen=true}else{for(var i=0,il=browserPrefixes.length;i<il;i++){fullScreenApi.prefix=browserPrefixes[i];if(typeof document[fullScreenApi.prefix+"CancelFullScreen"]!="undefined"){fullScreenApi.supportsFullScreen=true;break}}}if(fullScreenApi.supportsFullScreen){fullScreenApi.fullScreenEventName=fullScreenApi.prefix+"fullscreenchange";fullScreenApi.isFullScreen=function(){switch(this.prefix){case"":return document.fullScreen;case"webkit":return document.webkitIsFullScreen;default:return document[this.prefix+"FullScreen"]}};fullScreenApi.requestFullScreen=function(el){return(this.prefix==="")?el.requestFullScreen():el[this.prefix+"RequestFullScreen"]()};fullScreenApi.cancelFullScreen=function(el){return(this.prefix==="")?document.cancelFullScreen():document[this.prefix+"CancelFullScreen"]()}}if(typeof jQuery!="undefined"){jQuery.fn.requestFullScreen=function(){return this.each(function(){if(fullScreenApi.supportsFullScreen){fullScreenApi.requestFullScreen(this)}})}}window.fullScreenApi=fullScreenApi;(function(b){b.support.touch="ontouchend" in document;if(!b.support.touch){return}var c=b.ui.mouse.prototype,e=c._mouseInit,a;function d(g,h){if(g.originalEvent.touches.length>1){return}g.preventDefault();var i=g.originalEvent.changedTouches[0],f=document.createEvent("MouseEvents");f.initMouseEvent(h,true,true,window,1,i.screenX,i.screenY,i.clientX,i.clientY,false,false,false,false,0,null);g.target.dispatchEvent(f)}c._touchStart=function(g){var f=this;if(a||!f._mouseCapture(g.originalEvent.changedTouches[0])){return}a=true;f._touchMoved=false;d(g,"mouseover");d(g,"mousemove");d(g,"mousedown")};c._touchMove=function(f){if(!a){return}this._touchMoved=true;d(f,"mousemove")};c._touchEnd=function(f){if(!a){return}d(f,"mouseup");d(f,"mouseout");if(!this._touchMoved){d(f,"click")}a=false};c._mouseInit=function(){var f=this;f.element.bind("touchstart",b.proxy(f,"_touchStart")).bind("touchmove",b.proxy(f,"_touchMove")).bind("touchend",b.proxy(f,"_touchEnd"));e.call(f)}})(jQuery);function Ziggurat(v){var jsr=123456789;var wn=Array(128);var fn=Array(128);var kn=Array(128);function RNOR(){var hz=SHR3();var iz=hz&127;return(Math.abs(hz)<kn[iz])?hz*wn[iz]:nfix(hz,iz)}this.nextGaussian=function(){return RNOR()};function nfix(hz,iz){var r=3.442619855899;var r1=1/r;var x;var y;while(true){x=hz*wn[iz];if(iz==0){x=(-Math.log(UNI())*r1);y=-Math.log(UNI());while(y+y<x*x){x=(-Math.log(UNI())*r1);y=-Math.log(UNI())}return(hz>0)?r+x:-r-x}if(fn[iz]+UNI()*(fn[iz-1]-fn[iz])<Math.exp(-0.5*x*x)){return x}hz=SHR3();iz=hz&127;if(Math.abs(hz)<kn[iz]){return(hz*wn[iz])}}}function SHR3(){var jz=jsr;var jzr=jsr;jzr^=(jzr<<13);jzr^=(jzr>>>17);jzr^=(jzr<<5);jsr=jzr;return(jz+jzr)|0}function UNI(){return 0.5*(1+SHR3()/-Math.pow(2,31))}function zigset(v){jsr^=(typeof v==="number")?v:new Date().getTime();var m1=2147483648;var dn=3.442619855899;var tn=dn;var vn=0.00991256303526217;var q=vn/Math.exp(-0.5*dn*dn);kn[0]=Math.floor((dn/q)*m1);kn[1]=0;wn[0]=q/m1;wn[127]=dn/m1;fn[0]=1;fn[127]=Math.exp(-0.5*dn*dn);for(var i=126;i>=1;i--){dn=Math.sqrt(-2*Math.log(vn/dn+Math.exp(-0.5*dn*dn)));kn[i+1]=Math.floor((dn/tn)*m1);tn=dn;fn[i]=Math.exp(-0.5*dn*dn);wn[i]=dn/m1}}zigset(v)}function lightbox(lb,revert,callback){if(!lb.length){return}var l=lb.position().left;var t=lb.position().top;var h=$(document).height();var parent=lb.parent();var me=lb.detach();$("body").append('<div class="lightbox_bg"></div>');me.appendTo("body");lb.addClass("lightbox_top").show().attr("role","dialog");if(lb.find(".close").length==0){lb.prepend('<a href="#" class="close">&times;</a>')}$(".lightbox_top form").on("submit",{lb:lb,revert:revert},function(e){if(e.data.revert&&e.data.revert.length>0){if(e.data.revert.get(0).nodeName!="A"){e.data.revert=e.data.revert.find("a").eq(0)}e.data.revert.focus()}closeLightbox(e.data.lb)});$(".lightbox_top .close").show().on("click",{lb:lb,revert:revert,callback:callback},function(e){closeLightbox(e.data.lb);e.data.revert.focus();if(typeof e.data.callback==="function"){e.data.callback.call()}});$(".lightbox_bg").css({height:""});centre(lb);$(".lightbox_bg").on("click",{lb:lb,revert:revert,callback:callback},function(e){closeLightbox(e.data.lb);e.data.revert.focus();if(typeof e.data.callback==="function"){e.data.callback.call()}}).css({height:h+"px"});$(window).resize(function(){if($(window).height()>$(".lightbox_top").height()){centre(lb)}else{$(".lightbox_top").css("top",0)}$(".lightbox_bg").css({height:$(document).height()+"px"})});$(".lightbox_top form input:visible:first").focus();return}function closeLightbox(lb){speed=500;if($(".lightbox_bg").length>0){$(".lightbox_bg").fadeOut(speed,function(){$(this).remove()})}if(lb.length>0){lb.attr("role","");var parent=lb.parent();lb.fadeOut(speed,function(){$(this).removeClass("lightbox_top");me=$(this).detach();me.appendTo(parent)})}$("body").css("overflow-y","auto");if(typeof fn=="function"){fn.call()}}function centre(lb){var wide=$(window).width();var tall=$(window).height();var l=0;var t=0;if(lb.css("max-width").indexOf("px")>0){l=((wide-lb.outerWidth())/2);lb.css({left:((wide-lb.outerWidth())/2)+"px"});if($(window).height()>lb.height()){t=((tall-lb.outerHeight())/2+$(window).scrollTop());$("body").css("overflow-y","hidden")}}lb.css({left:l+"px",top:t+"px"})}$.simulator=function(placeholder,input){if(typeof input=="object"){input.container=placeholder}else{if(typeof placeholder=="string"){input={container:placeholder}}else{input=placeholder}}input.plugins=$.simulator.plugins;return new Simulator(input)};$.simulator.plugins=[]})(jQuery);